#!/bin/sh
# GitHub PR helper script
# Provides shortcuts for common GitHub PR operations

case "$1" in
  # w: view current PR in web browser
  w) shift; gh pr view -w "$@" ;;
  
  # t: view current PR in terminal
  t) shift; gh pr view "$@" ;;
  
  # k: show CI checks for current PR
  k) shift; gh pr checks "$@" ;;
  
  # kw: watch CI checks and run command when done
  kw) 
    shift
    cmd=""
    args=""
    while [ $# -gt 0 ]; do
      case "$1" in
        -c|--command) cmd="$2"; shift 2 ;;
        *) args="$args $1"; shift ;;
      esac
    done
    if [ -z "$cmd" ]; then
      repo=$(gh repo view --json name -q .name)
      pr=$(gh pr view --json number -q .number)
      cmd="say $repo $pr done"
    fi
    gh pr checks --watch $args && eval "$cmd" ;;
  
  # d: view diff of current PR
  d) shift; gh pr diff "$@" ;;
  
  # s: select and checkout a PR using fzf
  # Lists PRs with author, number, and title.
  # Uses `column` to lay them out in a table for easier reading in the `fzf` window.
  # Truncates app/* usernames to app/abcdefg… for readability
  s) gh pr list --limit 500 --json number,title,author --template '{{range .}}{{.author.login}}{{"\t"}}#{{.number}}{{"\t"}}{{.title}}{{"\n"}}{{end}}' | \
     awk -F'\t' '{if ($1 ~ /^app\//) {sub(/^app\//, "app/", $1); $1 = "app/" substr($1, 5, 7) "…"} print}' OFS='\t' | \
     column -t -s $'\t' | \
     fzf | \
     awk '{print $2}' | \
     tr -d '#' | \
     xargs gh pr checkout ;;
  
  # c: create a new PR
  c) shift; gh pr create "$@" ;;
  
  # verify: check that documented flags match actual gh pr commands
  verify)
    echo "Verifying documented flags are complete..."
    errors=0
    
    # w and t: gh pr view
    expected="--comments --json --jq --template --web"
    actual=$(gh pr view --help | grep -E "^\s+-" | sed 's/,//g' | awk '{for(i=1;i<=NF;i++) if($i ~ /^--/) print $i}' | tr '\n' ' ')
    for flag in $expected; do
      case "$actual" in
        *"$flag"*) ;;
        *) echo "❌ w/t missing: $flag"; errors=$((errors + 1)) ;;
      esac
    done
    
    # k: gh pr checks
    expected="--fail-fast --interval --json --jq --required --template --watch --web"
    actual=$(gh pr checks --help | grep -E "^\s+-" | sed 's/,//g' | awk '{for(i=1;i<=NF;i++) if($i ~ /^--/) print $i}' | tr '\n' ' ')
    for flag in $expected; do
      case "$actual" in
        *"$flag"*) ;;
        *) echo "❌ k missing: $flag"; errors=$((errors + 1)) ;;
      esac
    done
    
    # d: gh pr diff
    expected="--color --name-only --patch --web"
    actual=$(gh pr diff --help | grep -E "^\s+-" | sed 's/,//g' | awk '{for(i=1;i<=NF;i++) if($i ~ /^--/) print $i}' | tr '\n' ' ')
    for flag in $expected; do
      case "$actual" in
        *"$flag"*) ;;
        *) echo "❌ d missing: $flag"; errors=$((errors + 1)) ;;
      esac
    done
    
    # c: gh pr create (subset)
    expected="--base --draft --dry-run --label --recover --reviewer --title --web"
    actual=$(gh pr create --help | grep -E "^\s+-" | sed 's/,//g' | awk '{for(i=1;i<=NF;i++) if($i ~ /^--/) print $i}' | tr '\n' ' ')
    for flag in $expected; do
      case "$actual" in
        *"$flag"*) ;;
        *) echo "❌ c missing: $flag"; errors=$((errors + 1)) ;;
      esac
    done
    
    if [ $errors -eq 0 ]; then
      echo "✅ All documented flags verified"
    else
      echo ""
      echo "Found $errors missing flag(s)"
      exit 1
    fi
    ;;
  
  # show usage for invalid options
  *) echo "Usage: gp {w|t|k|kw|d|s|c|verify} [flags]
  w  - view current PR in web browser
       flags: --comments, --json, --jq, --template, --web
  t  - view current PR in terminal
       flags: --comments, --json, --jq, --template, --web
  k  - show CI checks for current PR
       flags: --fail-fast, --interval, --json, --jq, --required, --template, --watch, --web
  kw - watch CI checks and run command when done
       flags: -c/--command (custom command), --fail-fast, --interval
  d  - view diff of current PR
       flags: --color, --name-only, --patch, --web
  s  - select and checkout a PR using fzf (no flags)
  c  - create a new PR
       flags: --base, --draft, --dry-run, --label, --recover, --reviewer, --title, --web
  verify - verify documented flags match actual gh pr commands
  
  All commands accept PR selectors: [<number> | <url> | <branch>]" >&2; exit 1 ;;
esac
