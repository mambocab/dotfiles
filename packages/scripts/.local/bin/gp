#!/bin/sh
# GitHub PR helper script
# Provides shortcuts for common GitHub PR operations

# Capture errors with command context
errfile=$(mktemp)
trap 'if [ -s "$errfile" ]; then cat "$errfile" >&2; fi; rm -f "$errfile"' EXIT

run_gh() {
  cmd="$*"
  prefix=$(printf "%.50s" "$cmd")
  [ ${#cmd} -gt 50 ] && prefix="$prefix..."
  tmpout=$(mktemp)
  if "$@" 2>"$tmpout"; then
    cat "$tmpout"
    rm "$tmpout"
    return 0
  else
    rc=$?
    sed "s|^|[$prefix] |" "$tmpout" >> "$errfile"
    rm "$tmpout"
    return $rc
  fi
}

# Flag definitions (single source of truth)
FLAGS_W_T="--comments --json --jq --template --web"
FLAGS_K="--fail-fast --interval --json --jq --required --template --watch --web"
FLAGS_KW="--fail-fast --interval"
FLAGS_D="--color --name-only --patch --web"
FLAGS_C="--base --draft --dry-run --label --recover --reviewer --title --web"

case "$1" in
  # w: view current PR in web browser
  w) shift; gh pr view -w "$@" ;;

  # t: view current PR in terminal
  t) shift; gh pr view "$@" ;;

  # k: show CI checks for current PR
  k) shift; gh pr checks "$@" ;;

  # kw: watch CI checks and run command when done
  kw)
    shift
    cmd=""
    args=""
    while [ $# -gt 0 ]; do
      case "$1" in
        -c|--command) cmd="$2"; shift 2 ;;
        *) args="$args $1"; shift ;;
      esac
    done
    if [ -z "$cmd" ]; then
      repo=$(gh repo view --json name -q .name)
      pr=$(gh pr view --json number -q .number) || exit 1
      cmd="say $repo $pr done"
    fi
    gh pr checks --watch $args && eval "$cmd" ;;

  # d: view diff of current PR
  d) shift; gh pr diff "$@" ;;

  # s: select and checkout a PR using fzf
  # Lists PRs with author, number, and title.
  # Uses `column` to lay them out in a table for easier reading in the `fzf` window.
  # Truncates app/* usernames to app/abcdefg… for readability
  s) gh pr list --limit 500 --json number,title,author --template '{{range .}}{{.author.login}}{{"\t"}}#{{.number}}{{"\t"}}{{.title}}{{"\n"}}{{end}}' | \
     awk -F'\t' '{if ($1 ~ /^app\//) {sub(/^app\//, "app/", $1); $1 = "app/" substr($1, 5, 7) "…"} print}' OFS='\t' | \
     column -t -s $'\t' | \
     fzf | \
     awk '{print $2}' | \
     tr -d '#' | \
     xargs gh pr checkout ;;

  # fd: fuzzy-find PRs across all repos for a user (as author or assignee)
  fd)
    shift
    user="@me"
    owner=""
    repo=""
    while [ $# -gt 0 ]; do
      case "$1" in
        --owner) owner="$2"; shift 2 ;;
        -R|--repo) repo="$2"; shift 2 ;;
        *) user="$1"; shift ;;
      esac
    done
    query="involves:$user"
    [ -n "$owner" ] && query="$query org:$owner"
    [ -n "$repo" ] && query="$query repo:$repo"
    selection=$(run_gh gh search prs "$query" --state open --limit 500 --json repository,number,title,author,url --template '{{range .}}{{.repository.nameWithOwner}}{{"\t"}}{{.author.login}}{{"\t"}}#{{.number}}{{"\t"}}{{.title}}{{"\t"}}{{.url}}{{"\n"}}{{end}}' | \
      awk -F'\t' '{if ($2 ~ /^app\//) {sub(/^app\//, "app/", $2); $2 = "app/" substr($2, 5, 7) "…"} print $1 "\t" $2 "\t" $3 "\t" $4 "\t" $5}' | \
      column -t -s $'\t' | \
      fzf) || exit 0
    [ -z "$selection" ] && exit 0
    echo "$selection" | awk '{print $NF}' ;;

  # c: create a new PR
  c) shift; gh pr create "$@" ;;

  # verify: check that documented flags match actual gh pr commands
  verify)
    # ANSI color codes
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    GRAY='\033[0;90m'
    RESET='\033[0m'

    # Helper function to colorize flags
    colorize_flags() {
      local expected="$1"
      local actual="$2"
      local ignored="$3"
      local result=""

      for flag in $actual; do
        case "$flag" in
          --help|--repo) continue ;;
        esac

        if [ -n "$ignored" ]; then
          case "$ignored" in
            *"$flag"*) result="$result${GRAY}$flag${RESET} "; continue ;;
          esac
        fi

        case "$expected" in
          *"$flag"*) result="$result${GREEN}$flag${RESET} " ;;
          *) result="$result${GRAY}$flag${RESET} " ;;
        esac
      done
      echo "$result"
    }

    echo "Verifying documented flags are complete..."
    echo ""
    errors=0

    # Process each check
    # Format: name|gh_command|flags_var|note|is_subset
    echo "w/t|gh pr view|FLAGS_W_T||no
k|gh pr checks|FLAGS_K||no
kw|gh pr checks|FLAGS_KW|(plus -c/--command for custom callback)|yes
s|||no
d|gh pr diff|FLAGS_D||no
c|gh pr create|FLAGS_C||yes" | while IFS='|' read -r name gh_cmd flags_var note is_subset; do

      echo "$name ($gh_cmd):"

      # Special case for s (no flags)
      if [ -z "$flags_var" ]; then
        echo "  No flags - custom interactive command"
        echo ""
        continue
      fi

      # Get expected flags
      eval "expected=\$$flags_var"

      # Get actual flags from gh help
      actual=$($gh_cmd --help | grep -E "^\s+-" | sed 's/,//g' | awk '{for(i=1;i<=NF;i++) if($i ~ /^--/) print $i}' | tr '\n' ' ')

      # Calculate ignored flags if this is a subset
      ignored=""
      if [ "$is_subset" = "yes" ]; then
        for flag in $actual; do
          case "$expected" in
            *"$flag"*) ;;
            *) case "$flag" in
              --help|--repo) ;;
              *) ignored="$ignored $flag" ;;
            esac ;;
          esac
        done
      fi

      # Display
      if [ -n "$note" ]; then
        echo "  Documented: $expected $note"
      else
        echo "  Documented: $expected"
      fi
      printf "  Available:  %b\n" "$(colorize_flags "$expected" "$actual" "$ignored")"

      # Check for missing flags
      for flag in $expected; do
        case "$actual" in
          *"$flag"*) ;;
          *) echo -e "  ${RED}❌ MISSING: $flag${RESET}"; errors=$((errors + 1)) ;;
        esac
      done
      echo ""
    done

    if [ $errors -eq 0 ]; then
      echo "✅ All documented flags verified"
    else
      echo "❌ Found $errors missing flag(s)"
      exit 1
    fi
    ;;

  # show usage for invalid options
  *) echo "Usage: gp {w|t|k|kw|d|s|fd|c|verify} [flags]
  w  - view current PR in web browser
       flags: $FLAGS_W_T
  t  - view current PR in terminal
       flags: $FLAGS_W_T
  k  - show CI checks for current PR
       flags: $FLAGS_K
  kw - watch CI checks and run command when done
       flags: -c/--command (custom command), $FLAGS_KW
  d  - view diff of current PR
       flags: $FLAGS_D
  s  - select and checkout a PR using fzf (no flags)
  fd - fuzzy-find PRs across all repos [user] (defaults to @me)
       flags: --owner, -R/--repo
  c  - create a new PR
       flags: $FLAGS_C
  verify - verify documented flags match actual gh pr commands

  Most commands accept PR selectors: [<number> | <url> | <branch>]
  Use with gp fd: gp w \$(gp fd) or gp kw \$(gp fd --owner myorg)" >&2; exit 1 ;;
esac
