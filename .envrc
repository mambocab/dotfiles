export FZF_CTRL_T_COMMAND='fd --type f --strip-cwd-prefix --hidden --no-ignore --exclude .git'

# Run macos-defaults.sh if its contents have changed
watch_file macos-defaults.sh
MACOS_DEFAULTS_HASH=$(shasum macos-defaults.sh | cut -d' ' -f1)
MACOS_DEFAULTS_HASH_FILE="$(direnv_layout_dir)/macos_defaults_hash"
MACOS_DEFAULTS_REJECTED="$(direnv_layout_dir)/macos-defaults-rejected"
mkdir -p "$(direnv_layout_dir)"
if [ ! -f "$MACOS_DEFAULTS_REJECTED" ] && { [ ! -f "$MACOS_DEFAULTS_HASH_FILE" ] || [ "$MACOS_DEFAULTS_HASH" != "$(cat "$MACOS_DEFAULTS_HASH_FILE")" ]; }; then
  printf "macos-defaults.sh changed. Apply macOS defaults? [y/N/never] "
  read -r _response < /dev/tty
  case "$_response" in
    [Yy]*)
      ./macos-defaults.sh
      echo "$MACOS_DEFAULTS_HASH" > "$MACOS_DEFAULTS_HASH_FILE"
      ;;
    never|NEVER)
      touch "$MACOS_DEFAULTS_REJECTED"
      echo "Permanently skipped. Remove macos-defaults-rejected from .direnv/ to re-enable."
      ;;
    *)
      echo "Skipped. Re-enter this directory to be prompted again, or run: just macos-defaults"
      ;;
  esac
fi

# Auto-install Brewfile if changed
watch_file Brewfile
BREWFILE_HASH=$(shasum Brewfile | cut -d' ' -f1)
BREWFILE_HASH_FILE="$(direnv_layout_dir)/brewfile_hash"
BREWFILE_REJECTED="$(direnv_layout_dir)/brewfile-rejected"
if [ ! -f "$BREWFILE_REJECTED" ] && { [ ! -f "$BREWFILE_HASH_FILE" ] || [ "$BREWFILE_HASH" != "$(cat "$BREWFILE_HASH_FILE")" ]; }; then
  printf "Brewfile changed. Run 'brew bundle'? [y/N/never] "
  read -r _response < /dev/tty
  case "$_response" in
    [Yy]*)
      brew bundle --file=Brewfile
      echo "$BREWFILE_HASH" > "$BREWFILE_HASH_FILE"
      ;;
    never|NEVER)
      touch "$BREWFILE_REJECTED"
      echo "Permanently skipped. Remove brewfile-rejected from .direnv/ to re-enable."
      ;;
    *)
      echo "Skipped. Re-enter this directory to be prompted again, or run: brew bundle --file=Brewfile"
      ;;
  esac
fi
